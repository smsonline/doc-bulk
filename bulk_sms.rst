Рассылка SMS
============

Отправка SMS-сообщений
----------------------

Для отправки SMS-сообщения абоненту, партнеру необходимо послать POST или GET запрос на сервер системы «Bulk» по адресу https://bulk.sms-online.com/.

.. |nbsp| unicode:: 0xA0
   :trim:

==================== ======================== ================================================================================
Параметр             Тип                      Описание
==================== ======================== ================================================================================
**Обязательные параметры**
------------------------------------------------------------------------------------------------------------------------------
txt                  String |nbsp| (2048)     Текст отправляемого SMS-сообщения (по умолчанию – в кодировке UTF-8).
                                              
                                              При передаче параметра txt, содержащего спецсимволы (в том числе, пробел),
                                              его нужно закодировать URI при помощи функции rawurlencode() или аналогичной.
user                 String                   Логин партнёра.
from                 String |nbsp| (11)       Альфа-имя отправителя сообщения – цифры или латинские символы
phone[1..n]          Number                   Номер телефона получателя в международном формате: только цифры, без знака «плюс»,
                                              код страны, код оператора, телефон. Если необходимо отправить сообщение на
                                              несколько номеров, то требуется передавать несколько полей «phone» 
sign                 String                   `Цифровая подпись`_
**Опциональные параметры**
------------------------------------------------------------------------------------------------------------------------------
pref                 String                   Префикс для отправки ответных SMS-сообщений абонентов на сервис
                                              партнера. См. :ref:`режим сессии <ref-session>`
sending_method       String                   Для отправки SMS-сообщений доступно только значение "sms"
p_transaction_id     String                   Идентификатор транзакции в системе партнёра. Используется для сверок статистики и
                                              передаётся партнёру при передаче уведомлений о доставке
charset              String                   Кодировка параметра txt:

                                              * UTF8 или UTF-8 (по умолчанию) – явное указание кодировки Unicode UTF-8
                                              * UTF-16BE или UCS-2 – кодировка Unicode UTF-16 Big Endian
                                              * CP1251 – явное указание кодировки Windows-1251
delay                Number                   Отложить отправку сообщения абоненту на указанное количество минут.

                                              Максимальное значение – 10080 (неделя).
dlr                  Number                   Отчёт о доставке сообщения:

                                              * 0 (по умолчанию) – без отчета о доставке сообщения
                                              * 1 – запросить отчет о доставке сообщения (см. п. 5)
==================== ======================== ================================================================================

В параметре «from» допустимо передавать числовое или символьное значение (только латинские буквы, цифры, пробелы, длина – до 11 символов включительно), регистр имеет значение. Телефонный аппарат абонента отобразит значение этого параметра в поле «От:» (зависит от модели). В целях безопасности доставка сообщений с произвольными параметрами from без согласования с менеджером «SMS Online» производиться не будет. После тестирования вы должны сообщить выбранный вами параметр «from» вашему менеджеру или через форму обратной связи для закрепления данного альфа-имени за вами.

Если сообщение содержит только символы из базового набора кодировки GSM 03.38, то при длине текста ≤ 160 символам будет тарифицировано одно MT-сообщение, при большей длине сообщение будет разбито на части по 153 символа и тарифицирована каждая часть.

Если сообщение содержит хотя бы один символ вне базового набора кодировки GSM 03.38 (например, кириллица) и длина текста сообщения составит до 70 символов /включительно/, то будет тарифицировано одно MT-сообщение. Если длина ответа 71 и более символов, то количество сообщений будет 2 и более (длинные сообщения делятся на части и тарифицируются по 67 символов в соответствии со стандартами GSM).

Партнёр может передавать символ новой строки в параметре «txt» в том виде, в котором ему удобнее: в виде «\n» или «\r» или в виде «<br>». Система «Bulk» распознает все варианты и отправит абоненту SMS с переводом строки.

.. include:: includes/bulk_sign.rst

Коды ответа системы «Bulk»
------------------------------

Система «Bulk» отвечает на запросы об отправке SMS-сообщений в XML.

**Примеры ответов системы:**

.. code-block:: xml

    <!-- Если запрос соответствует протоколу, то ответ скрипта будет таким -->
    <?xml version="1.0" encoding="utf-8"?>
    <response>
      <code>0</code>
      <tech_message>OK</tech_message>
    </response>

.. code-block:: xml

    <!-- Если произошла ошибка, то параметр «code» будет меньше нуля. В этом случае поле «tech_message» содержит текстовое описание ошибки. -->
    <?xml version="1.0" encoding="utf-8"?>
    <response>
      <code>-1</code>
      <tech_message>PARAM ERROR (phone)</tech_message>
    </response>

По умолчанию установлено ограничение для SMS рассылок: 10 SMS/секунду. Если требуется более высокая скорость – сообщите об этом вашему менеджеру.

Обратите внимание, что безошибочный ответ («code=0») рассылочного скрипта не означает, что сообщение будет доставлено, а означает, что запрос принят в обработку системой.

**Расшифровка кодов ответов системы:**

==== ================================= ===============
Код  Описание                          Повтор запроса
==== ================================= ===============
0    Запрос успешно обработан          нет
-1   Неверные входные данные           нет
-2   Ошибка аутентификации             нет
-3   Отказ в обработке запроса         нет
-4   Временная техническая ошибка      да
-5   Исчерпан баланс SMS-сообщений     нет
==== ================================= ===============


Отчёты о доставке
-----------------

Система поддерживает передачу партнёру информации о статусах доставки сообщений (DLR) абоненту. Если в запросе на отправку сообщения указывается параметр «dlr=1», то в ответном XML, помимо статуса, будет выдан идентификатор отправленного сообщения («msg_id»). Идентификаторов может быть больше одного в случае отправки сообщений для нескольких абонентов в одном запросе.


**Пример ответа системы с msg_id:**

.. code-block:: xml

    <?xml version="1.0"?>
    <response>
        <tech_message>OK</tech_message>
        <code>0</code>
        <msg_id phone="79031234567">550e8400-e29b-41d4-a716-446655440000</msg_id>
        <msg_id phone="79165557755">550e8400-e29b-41d4-a716-446655440001</msg_id>
    </response>


Для получения уведомления партнёру необходимо:

*  Разработать скрипт, принимающий уведомления о доставке (по HTTPS) в соответствии с описанным ниже протоколом, и сообщить его адрес менеджеру «SMS Online».
* Разрешить вызов скрипта с ip-адресов, присланных менеджером «SMS Online».
* Сообщить менеджеру, нужно ли доставлять промежуточные статусы или только финальные.

При обновлении статуса доставки в системе «Bulk», на вход скрипту партнёра будут передаваться три параметра:

==================== ===================== ================================================================================
Параметр             Тип                   Описание
==================== ===================== ================================================================================
msg_id               String |nbsp| (36)    Идентификатор сообщения в системе «Bulk»
p_transaction_id     String                Информация, переданная партнёром в запросе на отправку сообщения
status               Number                Код статуса доставки
==================== ===================== ================================================================================

Статусы доставки могут доставляться стандартными методами POST или GET и протоколами HTTP или HTTPS по выбору партнёра.

В ответ на запрос скрипт партнера должен вернуть HTTP-код ответа 200 OK с любым текстом. В случае иного HTTP-кода ответа уведомление будет отправляться повторно в течение 24 часов.

Статусы доставки передаются на скрипт партнёра, заданный в настройках системы «Bulk».

**Коды статусов доставки**

=== ================== =========================================================
Код Значение           Описание                                                 
=== ================== =========================================================
4   process            Обрабатывается
1   buffered           В буфере
0   delivered          Сообщение успешно доставлено
-1  not delivered      Сообщение не доставлено (ошибка доставки)                
-2  expired            Просрочено, удалено с SMSC (абонент недоступен 24ч.)     
-3  rejected           Отказ в передаче сообщения оператором (неверный номер,   
                       у абонента включен запрет приема СМС и др.)
-11 route_not_found    Маршрут не найден
-12 http_req_error     Ошибка запроса к шлюзу
=== ================== =========================================================

.. _ref-session:

Режим сессии
------------

Система «SMS Online» поддерживает работу в сессионном режиме: при отправке SMS абоненту можно указать префикс сессии (параметр «pref») для возможности отправки ответных сообщений (нажатие на кнопку «Ответить» в телефоне) на ваш сервис через систему «SMS Payment» (в случае необходимости, для получения документации на эту систему необходимо обратиться к менеджеру «SMS Online»).

.. note:: Префикс должен быть подключен в системе «SMS Payment».


**Пример:** партнёр отправляет абоненту сообщение с параметрами:

.. code-block:: none

   from = 1320
   txt  = Для участия в викторине пришлите ваш возраст в ответ на эту SMS
   pref = VIKTORINA


Пользователю достаточно будет просто ответить на SMS-сообщение (нажать на кнопку «ответить» в телефоне). Например, он написал «26лет». Тогда на скрипт партнёра сообщение поступит в виде:

.. code-block:: none

   pref=VIKTORINA   txt=26лет

Режим сессии включается на срок 48 часов. Помимо конкурсов и викторин, данная функция может быть использована для отправки подтверждений, диалогов, чатов и т. д.
